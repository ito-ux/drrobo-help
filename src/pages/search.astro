---
import Layout from "@layouts/Layout.astro";
import { getBlogList } from "@libs/microcms.ts";

export const prerender = true;

const q = Astro.url.searchParams.get("q") ?? "";

// ✅ ビルド時に記事一覧を取り込んでおく（staticでも動く）
const { contents } = await getBlogList({ limit: 100 });
const items = contents.map((p) => ({
  id: p.id,
  title: p.title ?? "",
  description: p.description ?? "",
}));

const Meta = { title: q ? `検索: ${q}` : "検索" };
---

<Layout Meta={Meta}>
<div slot="main" class="space-y-6">
  <!-- タイトル左 / 検索フォーム右 -->
  <section class="rounded-2xl bg-gray-50 p-6 md:p-8">
    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
      <div>
        <h1 class="text-2xl font-semibold tracking-tight">検索結果</h1>
        <p id="summary" class="mt-2 text-sm text-gray-600"></p>
      </div>

<form
  method="get"
  action="/search"
  class="flex items-stretch overflow-hidden rounded-full border border-gray-300 bg-white"
>
  <input
    name="q"
    type="search"
    value={q}
    placeholder="キーワードで検索（例：CSV、初期設定）"
    class="w-[360px] max-w-[60vw] px-6 py-3 text-sm outline-none"
  />

  <button
    type="submit"
    class="bg-black px-6 py-3 text-sm font-medium text-white"
  >
    検索
  </button>
</form>

    </div>
  </section>

  <!-- 結果一覧：お知らせ一覧のカード風 -->
  <section class="rounded-2xl border bg-white p-6">
    <div id="result" class="divide-y"></div>
    <div class="mt-4 text-sm text-gray-500">
      <span id="count"></span>
    </div>
  </section>

  <script define:vars={{ ITEMS: items, INITIAL_Q: q }}>
    const params = new URLSearchParams(location.search);
    const q = (params.get("q") || INITIAL_Q || "").trim().toLowerCase();

    const resultEl = document.getElementById("result");
    const summaryEl = document.getElementById("summary");
    const countEl = document.getElementById("count");

    if (!resultEl || !summaryEl || !countEl) return;

    const escapeHtml = (s) =>
      String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");

    if (!q) {
      summaryEl.textContent = "キーワードを入力して検索してください";
      resultEl.innerHTML = `<div class="py-3 text-sm text-gray-600">キーワードを入力してください。</div>`;
      countEl.textContent = "";
    } else {
      const hits = ITEMS.filter((x) => {
        const t = (x.title || "").toLowerCase();
        const d = (x.description || "").toLowerCase();
        return t.includes(q) || d.includes(q);
      });

      summaryEl.innerHTML = `「<b>${escapeHtml(q)}</b>」の検索結果：${hits.length}件`;

      if (!hits.length) {
        resultEl.innerHTML = `<div class="py-3 text-sm text-gray-600">一致する記事がありません。</div>`;
        countEl.textContent = "";
      } else {
        const show = hits.slice(0, 50);

        resultEl.innerHTML = show.map((item) => {
          const desc = (item.description || "");
          const short = desc.slice(0, 80);
          const more = desc.length > 80 ? "…" : "";

          return `
            <a class="block py-3 hover:bg-gray-50 rounded-lg px-2 -mx-2"
               href="/docs/${encodeURIComponent(item.id)}/">
              <div class="text-sm font-medium text-gray-900">
                ${escapeHtml(item.title || "（無題）")}
              </div>
              ${
                short
                  ? `<div class="mt-1 text-xs text-gray-600">${escapeHtml(short)}${more}</div>`
                  : ""
              }
            </a>
          `;
        }).join("");

        countEl.textContent =
          show.length < hits.length
            ? `表示：${show.length}件 / 全${hits.length}件`
            : `全${hits.length}件`;
      }
    }
  </script>
</div>

</Layout>
