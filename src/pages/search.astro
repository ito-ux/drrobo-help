---
import Layout from "@layouts/Layout.astro";
import { getBlogList } from "@libs/microcms.ts";

export const prerender = true;

const q = Astro.url.searchParams.get("q") ?? "";

// ✅ ビルド時に記事一覧を取り込んでおく（staticでも動く）
const { contents } = await getBlogList({ limit: 100 });
const items = contents.map((p) => ({
  id: p.id,
  title: p.title ?? "",
  description: p.description ?? "",
}));

const Meta = { title: q ? `検索: ${q}` : "検索" };
---

<Layout Meta={Meta}>
  <section class="space-y-4">
    <h1 class="text-2xl font-bold">検索結果</h1>

    <form method="get" action="/search" class="space-y-2">
      <input
        name="q"
        type="search"
        value={q}
        placeholder="キーワードで検索"
        class="w-full rounded-xl border border-gray-300 px-4 py-3"
      />
      <button class="rounded-xl border px-4 py-2">検索</button>
    </form>

    <div id="result" class="space-y-2"></div>
  </section>

<script define:vars={{ ITEMS: items }}>
  const params = new URLSearchParams(location.search);
  const q = (params.get("q") || "").trim().toLowerCase();

  const resultEl = document.getElementById("result");

  const escapeHtml = (s) =>
    String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");

  if (!q) {
    resultEl.innerHTML = "<p>キーワードを入力してください。</p>";
  } else {
    const hits = ITEMS.filter((x) => {
      const t = (x.title || "").toLowerCase();
      const d = (x.description || "").toLowerCase();
      return t.includes(q) || d.includes(q);
    });

    if (!hits.length) {
      resultEl.innerHTML = `<p>「<b>${escapeHtml(q)}</b>」に一致する記事がありません。</p>`;
    } else {
      resultEl.innerHTML = `
        <p>「<b>${escapeHtml(q)}</b>」の検索結果：${hits.length}件</p>
        <ul class="list-disc pl-5">
          ${hits.slice(0, 50).map((item) => `
            <li class="my-2">
              <a class="underline" href="/blog/${item.id}/">${escapeHtml(item.title || "（無題）")}</a>
              ${item.description ? `<div class="text-sm opacity-70">${escapeHtml(item.description)}</div>` : ""}
            </li>
          `).join("")}
        </ul>
      `;
    }
  }
</script>

</Layout>
