---
import Layout from "@layouts/Layout.astro";

export const prerender = true;

const q = Astro.url.searchParams.get("q") ?? "";
const Meta = { title: q ? `検索: ${q}` : "検索" };
---

<Layout Meta={Meta}>
  <section class="space-y-4">
    <h1 class="text-2xl font-bold">検索結果</h1>

    <form method="get" action="/search" class="space-y-2">
      <input
        name="q"
        type="search"
        value={q}
        placeholder="キーワードで検索"
        class="w-full rounded-xl border border-gray-300 px-4 py-3"
      />
      <button class="rounded-xl border px-4 py-2">検索</button>
    </form>

    <div id="result" class="space-y-2"></div>
  </section>

  <script type="module">
    import Fuse from "fuse.js";

    const params = new URLSearchParams(location.search);
    const q = (params.get("q") || "").trim();
    const resultEl = document.getElementById("result");

    async function main() {
      if (!q) {
        resultEl.innerHTML = "<p>キーワードを入力してください。</p>";
        return;
      }
      const res = await fetch("/search-index.json");
      const items = await res.json();

      const fuse = new Fuse(items, { threshold: 0.35, keys: ["title", "description"] });
      const hits = fuse.search(q).slice(0, 50);

      if (!hits.length) {
        resultEl.innerHTML = "<p>該当する記事がありません。</p>";
        return;
      }

      const escapeHtml = (s) =>
        String(s)
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");

      resultEl.innerHTML = `
        <p>「<b>${escapeHtml(q)}</b>」の検索結果：${hits.length}件</p>
        <ul class="list-disc pl-5">
          ${hits.map(({ item }) => `
            <li class="my-2">
              <a class="underline" href="/blog/${item.id}/">${escapeHtml(item.title || "（無題）")}</a>
              ${item.description ? `<div class="text-sm opacity-70">${escapeHtml(item.description)}</div>` : ""}
            </li>
          `).join("")}
        </ul>
      `;
    }

    main();
  </script>
</Layout>
