---
import { getBlogDetail, getCategoryList, getBlogList } from "@libs/microcms.ts";
import Layout from "@layouts/Layout.astro";
import BlogPost from "@components/BlogPost.astro";
import CategoryList from "@components/CategoryList.astro";

export const prerender = true;

// ✅ 追加：静的生成する対象（id一覧）を返す
export async function getStaticPaths() {
  const { contents } = await getBlogList({ limit: 100 }); // 記事数が100超えるなら後で拡張
  return contents.map((post) => ({
    params: { id: post.id },
  }));
}

const { id } = Astro.params;
if (!id) throw new Error("id is required");

// const url = new URL(Astro.url.href);
// const draftKey = url.searchParams.get("draftKey");
// 
// const cachePolicies = {
//   noCache: "no-store, no-cache, max-age=0, must-revalidate",
//   publicIsr: "public, s-maxage=180, stale-while-revalidate=180",
// };
// 
// const cachePolicy = draftKey ? cachePolicies.noCache : cachePolicies.publicIsr;
// Astro.response.headers.set("Cache-Control", cachePolicy);
// 
// const blog = await getBlogDetail(id, draftKey ? { draftKey } : {});

const blog = await getBlogDetail(id);

const { contents: categories } = await getCategoryList();

const Meta = {
  title: blog?.title ?? "記事が見つかりません",
  image: blog?.thumbnail?.url ?? "/assets/images/og.png",
  ogType: "article",
  description: blog?.description ?? "",
};
---
