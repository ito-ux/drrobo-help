---
import { getBlogDetail, getCategoryList, getBlogList } from "@libs/microcms.ts";
import Layout from "@layouts/Layout.astro";
import BlogPost from "@components/BlogPost.astro";
import CategoryList from "@components/CategoryList.astro";
import TOC from "@components/TOC.astro";

import {
  microCMSRichEditorHandler,
  syntaxHighlightingByShikiTransformer,
  responsiveImageTransformer,
  codeBlockFileNameTransformer,
  tocExtractor,
} from "microcms-rich-editor-handler";

// ...既存の getStaticPaths / fetch blog などはそのまま...

const blog = await getBlogDetail(id);
const { contents: categories } = await getCategoryList();

// ✅ ここで本文HTML化 + TOC抽出
type TocItem = { id: string; text: string; level: number };
let toc: TocItem[] = [];

if (blog?.content) {
  const { html: transformedHtml, data } = await microCMSRichEditorHandler(blog.content, {
    transformers: [
      responsiveImageTransformer(),
      codeBlockFileNameTransformer({ attributes: { class: "fileName" } }),
      syntaxHighlightingByShikiTransformer({
        defaultHighlightOptions: { lang: "javascript", theme: "github-dark" },
      }),
    ],
    extractors: {
      toc: [
        tocExtractor({ ignoreLevels: [4, 5] }),
      ],
    },
  });

  blog.content = transformedHtml;
  toc = data.toc ?? [];
}

const Meta = {
  title: blog?.title ?? "記事が見つかりません",
  image: blog?.thumbnail?.url ?? "/assets/images/og.png",
  ogType: "article",
  description: blog?.description ?? "",
};
---
<Layout Meta={Meta}>
  <div slot="main" class="space-y-8">
    {blog ? <BlogPost blog={blog} /> : <p>記事が見つかりません</p>}
  </div>

  <div slot="sidebar" class="space-y-8">
    <TOC toc={toc} sticky={true} />
    <CategoryList categories={categories} />
  </div>
</Layout>
