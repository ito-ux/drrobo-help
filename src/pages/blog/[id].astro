---
import Layout from "@layouts/Layout.astro";
import { getBlogList, getBlogDetail } from "@libs/microcms.ts";

export const prerender = true;

/**
 * microCMSのlist APIは limit <= 100 制限があるので、
 * offset を使って全件分のidを取り切る。
 */
export async function getStaticPaths() {
  const limit = 100;

  // まず総件数を取る（contentsも返る前提）
  const first = await getBlogList({ limit, offset: 0 });
  const totalCount = first.totalCount ?? first.contents?.length ?? 0;

  const all = [...(first.contents ?? [])];

  for (let offset = limit; offset < totalCount; offset += limit) {
    const page = await getBlogList({ limit, offset });
    all.push(...(page.contents ?? []));
  }

  return all.map((post) => ({
    params: { id: post.id },
  }));
}

const { id } = Astro.params;
if (!id) throw new Error("id is required");

let post: any = null;
let errorMsg: string | null = null;

try {
  post = await getBlogDetail(id);
} catch (e: any) {
  errorMsg = e?.message ?? "getBlogDetail failed";
}
---

<Layout title={post?.title ?? "記事"}>
  <main style="max-width: 920px; margin: 0 auto; padding: 24px;">
    <p style="opacity:.6; font-size:12px;">/blog/{id}</p>

    {errorMsg ? (
      <>
        <h1>記事の読み込みに失敗しました</h1>
        <pre style="white-space:pre-wrap; opacity:.7;">{errorMsg}</pre>
      </>
    ) : (
      <>
        <h1>{post?.title ?? "（タイトル未設定）"}</h1>

        {post?.eyecatch?.url ? (
          <img src={post.eyecatch.url} alt="" style="max-width:100%; height:auto;" />
        ) : null}

        {post?.content ? (
          <div set:html={post.content} />
        ) : post?.body ? (
          <div set:html={post.body} />
        ) : (
          <p style="opacity:.7;">本文がありません（content/body のどちらも空、またはフィールド名が違う可能性）</p>
        )}
      </>
    )}
  </main>
</Layout>
