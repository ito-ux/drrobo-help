---
export const prerender = false;

import { getBlogDetail } from "@libs/microcms.ts";
import Layout from "@layouts/Layout.astro";
import BlogPost from "@components/BlogPost.astro";
import TOC from "@components/TOC.astro";

import {
  microCMSRichEditorHandler,
  syntaxHighlightingByShikiTransformer,
  responsiveImageTransformer,
  codeBlockFileNameTransformer,
  tocExtractor,
} from "microcms-rich-editor-handler";
import { calloutTransformer } from "@libs/calloutTransformer.ts";

const { id } = Astro.params;
const draftKey = Astro.url.searchParams.get("draftKey") ?? undefined;

// ✅ draftKey を渡して下書きを取る
const blog = await getBlogDetail(id!, draftKey ? { draftKey } : undefined);

// TOC などは /docs と同じ処理でOK
type TocItem = { id: string; text: string; level: number };
let toc: TocItem[] = [];

if (blog?.content) {
  const { html: transformedHtml, data } = await microCMSRichEditorHandler(blog.content, {
    transformers: [
      calloutTransformer,
      responsiveImageTransformer(),
      codeBlockFileNameTransformer({ attributes: { class: "fileName" } }),
      syntaxHighlightingByShikiTransformer({
        defaultHighlightOptions: { lang: "javascript", theme: "github-dark" },
      }),
    ],
    extractors: { toc: [tocExtractor({ ignoreLevels: [4, 5] })] },
  });

  blog.content = transformedHtml;
  toc = data.toc ?? [];
}

const Meta = {
  title: blog?.title ?? "プレビュー",
  image: blog?.thumbnail?.url ?? "/assets/images/og.png",
  ogType: "article",
  description: blog?.description ?? "",
};

// サブナビは既存の /docs と同じでOK（必要ならコピペ）
const subnavItems = [
  { label: "スタートガイド", href: "/start/" },
  { label: "コマンド一覧", href: "/commands/" },
  { label: "コンソール", href: "/console/" },
  { label: "開発事例", href: "/cases/" },
  { label: "トラブルシューティング", href: "/troubleshooting/" },
];

const categoryName = blog?.category?.[0]?.name ?? "";
const activeHref =
  categoryName.includes("スタート") ? "/start/" :
  categoryName.includes("コマンド") ? "/commands/" :
  categoryName.includes("コンソール") ? "/console/" :
  categoryName.includes("開発") ? "/cases/" :
  categoryName.includes("トラブル") ? "/troubleshooting/" :
  "/commands/";
---

<Layout Meta={Meta} subnav={{ items: subnavItems, currentPath: Astro.url.pathname, activeHref }}>
  <div slot="main" class="space-y-8">
    {blog ? <BlogPost blog={blog} /> : <p>記事が見つかりません</p>}
  </div>

  <div slot="sidebar" class="space-y-8 md:self-start">
    <TOC toc={toc} title="目次" sticky={true} />
  </div>
</Layout>
