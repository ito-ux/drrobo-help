---
import { getBlogDetail, getBlogList } from "@libs/microcms.ts";
import Layout from "@layouts/Layout.astro";
import BlogPost from "@components/BlogPost.astro";
import TOC from "@components/TOC.astro";

import {
  microCMSRichEditorHandler,
  syntaxHighlightingByShikiTransformer,
  responsiveImageTransformer,
  codeBlockFileNameTransformer,
  tocExtractor,
} from "microcms-rich-editor-handler";

import { calloutTransformer } from "@libs/calloutTransformer.ts";


/**
 * ✅ 静的サイト（output: "static"）では必須
 * /docs/[id] を生成するための全ID一覧を返す
 */
export async function getStaticPaths() {
  const data = await getBlogList({ limit: 100 });
  return data.contents.map((item) => ({
    params: { id: item.id },
  }));
}

const { id } = Astro.params;
const blog = await getBlogDetail(id);

// ✅ 本文HTML化 + TOC抽出
type TocItem = { id: string; text: string; level: number };
let toc: TocItem[] = [];

if (blog?.content) {
  const { html: transformedHtml, data } = await microCMSRichEditorHandler(blog.content, {
    transformers: [
      calloutTransformer,
      responsiveImageTransformer(),
      codeBlockFileNameTransformer({ attributes: { class: "fileName" } }),
      syntaxHighlightingByShikiTransformer({
        defaultHighlightOptions: { lang: "javascript", theme: "github-dark" },
      }),
    ],
    extractors: {
      toc: [tocExtractor({ ignoreLevels: [4, 5] })],
    },
  });

  blog.content = transformedHtml;
  toc = data.toc ?? [];
}

const Meta = {
  title: blog?.title ?? "記事が見つかりません",
  image: blog?.thumbnail?.url ?? "/assets/images/og.png",
  ogType: "article",
  description: blog?.description ?? "",
};

// ✅ サブナビ（共通）
const subnavItems = [
  { label: "スタートガイド", href: "/start/" },
  { label: "コマンド一覧", href: "/commands/" },
  { label: "コンソール", href: "/console/" },
  { label: "開発事例", href: "/cases/" },
  { label: "トラブルシューティング", href: "/troubleshooting/" },
];

// ✅ category名 → サブナビ現在地（activeHref）にマッピング
const categoryName = blog?.category?.[0]?.name ?? "";

// ざっくりでも壊れないように「含む」で判定（microCMS側の表記ゆれ対策）
const activeHref =
  categoryName.includes("スタート") ? "/start/" :
  categoryName.includes("コマンド") ? "/commands/" :
  categoryName.includes("コンソール") ? "/console/" :
  categoryName.includes("開発") ? "/cases/" :
  categoryName.includes("トラブル") ? "/troubleshooting/" :
  "/commands/"; // 迷ったらコマンド扱い
---

<Layout
  Meta={Meta}
  subnav={{ items: subnavItems, currentPath: Astro.url.pathname, activeHref }}
>

  <div slot="main" class="space-y-8">
    {blog ? <BlogPost blog={blog} /> : <p>記事が見つかりません</p>}
  </div>

  <div slot="sidebar" class="space-y-8 md:self-start">
    <TOC toc={toc} title="目次" sticky={true} />
  </div>
</Layout>
