---
import { getBlogDetail, getBlogList } from "@libs/microcms.ts";
import Layout from "@layouts/Layout.astro";
import BlogPost from "@components/BlogPost.astro";
import TOC from "@components/TOC.astro";

import {
  microCMSRichEditorHandler,
  syntaxHighlightingByShikiTransformer,
  responsiveImageTransformer,
  codeBlockFileNameTransformer,
  tocExtractor,
} from "microcms-rich-editor-handler";

/**
 * ✅ 静的サイト（output: "static"）では必須
 * /blog/[id] を生成するための全ID一覧を返す
 */
export async function getStaticPaths() {
  // まずは最大100件取得（件数が増えたら後でページング対応）
  const data = await getBlogList({ limit: 100 });

  return data.contents.map((item) => ({
    params: { id: item.id },
  }));
}

// ✅ 動的ルートのパラメータ（ここで id が定義される）
const { id } = Astro.params;

// ✅ 記事詳細・カテゴリ取得
const blog = await getBlogDetail(id);

// ✅ 本文HTML化 + TOC抽出
type TocItem = { id: string; text: string; level: number };
let toc: TocItem[] = [];

if (blog?.content) {
  const { html: transformedHtml, data } = await microCMSRichEditorHandler(blog.content, {
    transformers: [
      responsiveImageTransformer(),
      codeBlockFileNameTransformer({ attributes: { class: "fileName" } }),
      syntaxHighlightingByShikiTransformer({
        defaultHighlightOptions: { lang: "javascript", theme: "github-dark" },
      }),
    ],
    extractors: {
      toc: [tocExtractor({ ignoreLevels: [4, 5] })],
    },
  });

  blog.content = transformedHtml;
  toc = data.toc ?? [];
}

const Meta = {
  title: blog?.title ?? "記事が見つかりません",
  image: blog?.thumbnail?.url ?? "/assets/images/og.png",
  ogType: "article",
  description: blog?.description ?? "",
};
---

<Layout Meta={Meta}>
  <div slot="main" class="space-y-8">
    {blog ? <BlogPost blog={blog} /> : <p>記事が見つかりません</p>}
  </div>

<div slot="sidebar" class="md:self-start">
  <div class="md:sticky md:top-24">
    <!-- sticky確認用：追従すればこの枠が常に見える -->
    <div class="rounded-md border-2 border-red-400 bg-white p-2">
      <div class="text-xs font-semibold text-red-600 mb-2">TOC sticky debug</div>

      <div class="max-h-[calc(100vh-6rem)] overflow-auto pr-2">
        <TOC toc={toc} sticky={false} />
      </div>
    </div>
  </div>
</div>




</Layout>
