---
import Layout from "@layouts/Layout.astro";
import { getBlogDetail } from "@libs/microcms";

import {
  microCMSRichEditorHandler,
  syntaxHighlightingByShikiTransformer,
  responsiveImageTransformer,
  codeBlockFileNameTransformer,
  tocExtractor,
} from "microcms-rich-editor-handler";

import { calloutTransformer } from "@libs/calloutTransformer.ts";

export const prerender = true;

/**
 * 左メニュー（手書き）
 * - id は docs の contentId（= /docs/{id}/ の {id}）を入れる
 * - 先頭に「スタートガイドTOP（home）」を追加
 */
const startMenu = [
  { label: "スタートガイドTOP", id: "home" },
  { label: "RPAとは", id: "step1" },
  { label: "クライアントソフトのインストール", id: "install" },
  { label: "コンソールにログイン", id: "login-console" },
  { label: "アカウントを作成する", id: "create-account" },
  { label: "ロボットを作成する", id: "create-robot" },
  { label: "困ったときは（問い合わせ）", id: "support" },
];

// まずは docs 記事だけビルド時に取りに行く（home は除外）
type TocItem = { id: string; text: string; level: number };

const fetched = await Promise.all(
  startMenu
    .filter((item) => item.id !== "home")
    .map(async (item) => {
      try {
        const blog = await getBlogDetail(item.id);

        let toc: TocItem[] = [];

        if (blog?.content) {
          const { html, data } = await microCMSRichEditorHandler(blog.content, {
            transformers: [
              calloutTransformer,
              responsiveImageTransformer(),
              codeBlockFileNameTransformer({ attributes: { class: "fileName" } }),
              syntaxHighlightingByShikiTransformer({
                defaultHighlightOptions: { lang: "javascript", theme: "github-dark" },
              }),
            ],
            extractors: {
              toc: [tocExtractor({ ignoreLevels: [4, 5] })],
            },
          });

          blog.content = html;
          toc = data.toc ?? [];
        }

        return { ...item, ok: true as const, blog, toc };
      } catch {
        return { ...item, ok: false as const, blog: null, toc: [] as TocItem[] };
      }
    })
);

// home も含めたメニュー表示用（homeは常に有効扱い）
const menuWithData = [
  { label: "スタートガイドTOP", id: "home", ok: true as const, blog: null, toc: [] as TocItem[] },
  ...fetched,
];

// ✅ 初期表示は “home”
const initialId = "home";

const subnavItems = [
  { label: "スタートガイド", href: "/start/" },
  { label: "コマンド一覧", href: "/commands/" },
  { label: "コンソール", href: "/console/" },
  { label: "開発事例", href: "/cases/" },
  { label: "トラブルシューティング", href: "/troubleshooting/" },
];

function fmt(d?: string) {
  if (!d) return "";
  const dt = new Date(d);
  const y = dt.getFullYear();
  const m = String(dt.getMonth() + 1);
  const day = String(dt.getDate());
  return `${y}年${m}月${day}日`;
}
---

<Layout
  Meta={{
    title: "スタートガイド",
    description: "Dr.Roboをはじめて利用する方向けの情報をまとめています。",
    ogType: "website",
  }}
  mainPaddingY="pt-0 pb-0"
  subnav={{
    items: subnavItems,
    currentPath: Astro.url.pathname,
    activeHref: "/start/",
  }}
>
  <div slot="topbar">
    <section class="relative left-1/2 right-1/2 -ml-[50vw] -mr-[50vw] w-screen bg-white border-b border-gray-200 shadow-[0_2px_6px_rgba(15,23,42,0.06)]">
      <div class="mx-auto w-full max-w-6xl px-4 md:px-6 pt-6 pb-6">
        <h1 class="text-2xl md:text-3xl font-semibold text-sky-950">スタートガイド</h1>
        <p class="mt-2 text-sm md:text-base text-sky-950/70">
          Dr.Roboをはじめて利用する方向けの情報をまとめています。
        </p>
      </div>
    </section>
  </div>

  <div slot="main">
    <section class="grid grid-cols-1 md:grid-cols-[260px_1fr] gap-6">
      <!-- 左：手書きメニュー（見出し文字は削除） -->
      <aside class="md:pr-8">
        <div class="pt-6">
          <nav class="space-y-1" id="start-nav">
            {menuWithData.map((item) => {
              const href = `#${item.id}`;
              const disabled = item.id === "home" ? false : !item.ok;

              return (
                <a
                  href={href}
                  data-id={item.id}
                  class:list={[
                    "block rounded-md px-3 py-2 text-sm transition",
                    disabled
                      ? "text-gray-400 cursor-not-allowed"
                      : "text-gray-700 hover:bg-gray-100",
                  ]}
                  aria-disabled={disabled ? "true" : "false"}
                >
                  <span class="mr-2 text-gray-400">›</span>
                  {item.label}
                  {disabled && <span class="ml-2 text-xs">(未作成)</span>}
                </a>
              );
            })}
          </nav>
        </div>
      </aside>

      <!-- 右：本文 -->
      <div class="md:border-l md:border-gray-200 md:pl-8 min-w-0">
        <div class="pt-6" id="start-content">
          <!-- ✅ トップ（オリジナル）※「スタートガイド」見出しは削除 -->
          <article data-article="home" class="block">
            <p class="text-sm text-sky-950/70">
              左のメニューから項目を選ぶか、下のボタンから開始してください。
            </p>

<div class="mt-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
  <!-- RPAとは -->
<button
  type="button"
  class="group text-left rounded-xl border border-gray-200 p-4 hover:bg-gray-50 transition"
  data-go="step1"
>
<div class="mb-3 overflow-hidden rounded-lg border border-gray-200 shadow-sm bg-gray-50">
  <img
    src="/assets/images/start_guide/step1_btn.png"
    alt="RPAとは"
    class="w-full h-32 object-contain border-b border-gray-200"
    loading="lazy"
  />
</div>


  <div class="font-semibold text-sky-950 group-hover:underline">
    RPAとは
  </div>
  <div class="text-sm text-sky-950/70 mt-1">
    まず全体像を掴む
  </div>
</button>


<button
  type="button"
  class="group text-left rounded-xl border border-gray-200 p-4 hover:bg-gray-50 transition"
  data-go="step1"
>
  <div class="mb-3 overflow-hidden rounded-lg border border-gray-200 shadow-sm">
    <img
      src="/assets/images/start_guide/step1_btn.png"
      alt="RPAとは"
      class="w-full h-32 object-cover border-b border-gray-200"
    />
  </div>

  <div class="font-semibold text-sky-950 group-hover:underline">
    RPAとは
  </div>
  <div class="text-sm text-sky-950/70 mt-1">
    まず全体像を掴む
  </div>
</button>

</div>

          </article>

          <!-- ✅ docs記事：最初は全部 hidden -->
          {menuWithData
            .filter((item) => item.id !== "home")
            .map((item) => {
              const blog = item.blog;

              if (!blog) {
                return (
                  <article data-article={item.id} class="hidden">
                    <h2 class="text-xl font-semibold text-sky-950">{item.label}</h2>
                    <p class="mt-2 text-sm text-sky-950/70">この記事はまだ作成されていません。</p>
                  </article>
                );
              }

              const pub = fmt(blog.publishedAt || blog.createdAt);
              const upd = fmt(blog.revisedAt || blog.updatedAt);
              const cat = blog.category?.[0]?.name ?? "";

              return (
                <article data-article={item.id} class="hidden">
                  <header class="border-b border-gray-200 pb-4">
                    <h1 class="text-3xl font-bold text-sky-950">{blog.title}</h1>

                    <div class="mt-2 flex items-start justify-between gap-4">
                      <div class="min-w-0">
                        {cat && (
                          <span class="inline-flex items-center rounded-full bg-slate-700 px-3 py-1 text-xs font-semibold text-white">
                            {cat}
                          </span>
                        )}
                      </div>

                      <div class="text-right text-sm text-sky-950/70 whitespace-nowrap">
                        {pub && <span class="mr-4">公開日：{pub}</span>}
                        {upd && <span>最終更新日：{upd}</span>}
                      </div>
                    </div>
                  </header>

                  <div class="prose prose-slate max-w-none pt-6">
                    <Fragment set:html={blog.content} />
                  </div>
                </article>
              );
            })}
        </div>
      </div>
    </section>

    <script is:inline>
      const nav = document.getElementById("start-nav");
      const content = document.getElementById("start-content");

      function showArticle(id) {
        if (!content) return;

        content.querySelectorAll("[data-article]").forEach((el) => {
          el.classList.add("hidden");
        });

        const target = content.querySelector(`[data-article="${id}"]`);
        if (target) target.classList.remove("hidden");

        if (nav) {
          nav.querySelectorAll("a[data-id]").forEach((a) => {
            a.classList.remove("bg-gray-100", "text-gray-900", "font-semibold");
            a.classList.add("text-gray-700");
          });

          const active = nav.querySelector(`a[data-id="${id}"]`);
          if (active && active.getAttribute("aria-disabled") !== "true") {
            active.classList.add("bg-gray-100", "text-gray-900", "font-semibold");
            active.classList.remove("text-gray-700");
          }
        }
      }

      function idFromHash() {
        const h = location.hash.replace("#", "");
        return h || null;
      }

      // ✅ 初期：hashがあればそれ、なければ home
      const initial = idFromHash();
      if (initial) {
        showArticle(initial);
      } else {
        showArticle("home");
      }

      // 左メニュークリック
      nav?.addEventListener("click", (e) => {
        const a = e.target.closest("a[data-id]");
        if (!a) return;

        if (a.getAttribute("aria-disabled") === "true") {
          e.preventDefault();
          return;
        }

        const id = a.getAttribute("data-id");
        if (!id) return;

        showArticle(id);
      });

      // hash change
      window.addEventListener("hashchange", () => {
        const id = idFromHash();
        if (id) showArticle(id);
        else showArticle("home");
      });

      // トップ（画像ボタン）クリック
      content?.addEventListener("click", (e) => {
        const btn = e.target.closest("[data-go]");
        if (!btn) return;

        const id = btn.getAttribute("data-go");
        if (!id) return;

        location.hash = id;
        showArticle(id);
      });
    </script>
  </div>
</Layout>
