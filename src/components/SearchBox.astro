---
const placeholder = "キーワードで検索（例：CSV、初期設定）";
const { compact = false } = Astro.props as { compact?: boolean };
---

<div class={compact ? "w-full" : "mx-auto w-full max-w-2xl"}>
  <form action="/search" method="get" class="w-full">
    <div class="relative">
      <div class="flex items-stretch">
        <input
          id="q"
          type="search"
          name="q"
          placeholder={placeholder}
          autocomplete="off"
          class={`w-full border border-gray-300 bg-white text-gray-900 placeholder:text-gray-500
                 focus:outline-none focus:ring-2 focus:ring-orange-400
                 ${compact ? "h-8 px-4 text-sm rounded-l-full" : "px-6 py-3 text-base rounded-l-full"}`}
        />

        <button
          type="submit"
          class={`shrink-0 font-semibold text-white
                 bg-orange-500 hover:bg-orange-600
                 focus:outline-none focus:ring-2 focus:ring-orange-400
                 ${compact ? "h-8 px-4 text-sm rounded-r-full" : "px-6 py-3 text-sm rounded-r-full"}`}
        >
          検索
        </button>
      </div>

      <!-- ✅ サジェスト：中身がある時だけ表示（absoluteで下に“重ねる”） -->
      <div
        id="result"
        class="absolute left-0 right-0 top-full mt-2 z-50 hidden
               rounded-xl border border-gray-200 bg-white shadow-lg overflow-hidden"
        aria-live="polite"
      ></div>
    </div>
  </form>
</div>

<script>
  import Fuse from "fuse.js";

  const input = document.getElementById("q");
  const resultEl = document.getElementById("result");

  let fuse;
  let items = [];
  let timer;

  async function load() {
    const res = await fetch("/search-index.json");
    items = await res.json();

    fuse = new Fuse(items, {
      includeScore: true,
      threshold: 0.35,
      ignoreLocation: true,
      minMatchCharLength: 2,
      keys: [
        { name: "title", weight: 3.0 },
        { name: "description", weight: 1.5 },
        { name: "category", weight: 1.2 },
        { name: "tags", weight: 1.0 },
        { name: "body", weight: 0.8 },
      ],
    });
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function hideSuggest() {
    resultEl.classList.add("hidden");
    resultEl.innerHTML = "";
  }

  function render(list) {
    const q = input.value.trim();

    if (!q || !list.length) {
      hideSuggest();
      return;
    }

    const MAX = 5;
    const sliced = list.slice(0, MAX);
    const moreCount = Math.max(0, list.length - MAX);

    const html = `
      <ul style="list-style:none; padding:0; margin:0; text-align:left;">
        ${sliced.map(({ item }, i) => `
          <li style="${i === 0 ? "" : "border-top:1px solid #f3f4f6;"}">
            <a href="/docs/${item.id}/" style="display:block; padding:12px 14px; text-decoration:none;">
              <div style="font-weight:600; color:#111827;">
                ${escapeHtml(item.title || "（無題）")}
              </div>
              ${item.description ? `<div style="margin-top:4px; color:#6b7280; font-size:12px;">${escapeHtml(item.description)}</div>` : ""}
            </a>
          </li>
        `).join("")}
      </ul>

      <div style="border-top:1px solid #f3f4f6; padding:10px 14px; display:flex; justify-content:flex-end;">
        <a href="/search?q=${encodeURIComponent(q)}" style="font-size:12px; color:#111827; text-decoration:underline;">
          検索結果一覧へ${moreCount > 0 ? `（他 ${moreCount} 件）` : ""}
        </a>
      </div>
    `;

    resultEl.innerHTML = html;
    resultEl.classList.remove("hidden");
  }

  input.addEventListener("input", () => {
    clearTimeout(timer);
    timer = setTimeout(() => {
      const q = input.value.trim();
      if (!q || !fuse) { hideSuggest(); return; }
      render(fuse.search(q));
    }, 150);
  });

  input.addEventListener("search", () => {
    if (!input.value.trim()) hideSuggest();
  });

  input.addEventListener("blur", () => {
    setTimeout(() => hideSuggest(), 120);
  });

  document.addEventListener("click", (e) => {
    const within = e.target === input || resultEl.contains(e.target);
    if (!within) hideSuggest();
  });

  load();
</script>
