---
const placeholder = "キーワードで検索（例：CSV、初期設定）";
---

<div class="mx-auto w-full max-w-2xl">
  <form action="/search" method="get" class="w-full">
    <div class="flex items-stretch rounded-full border border-gray-300 bg-white overflow-hidden">
      <input
        id="q"
        type="search"
        name="q"
        placeholder={placeholder}
        autocomplete="off"
        class="w-full px-5 py-3 text-base outline-none"
      />
      <button
        type="submit"
        class="shrink-0 px-5 text-sm font-semibold bg-black text-white hover:bg-black/90"
      >
        検索
      </button>
    </div>
  </form>

  <div id="result" class="mt-3"></div>
</div>

<script>
  import Fuse from "fuse.js";

  const input = document.getElementById("q");
  const resultEl = document.getElementById("result");

  let fuse;
  let items = [];

  async function load() {
    const res = await fetch("/search-index.json");
    items = await res.json();
    fuse = new Fuse(items, {
      includeScore: true,
      threshold: 0.35,
      keys: ["title", "description"],
    });
  }

  function render(list) {
    if (!list.length) {
      resultEl.innerHTML = "";
      return;
    }

    const html = `
      <div style="border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; background:#fff;">
        <ul style="list-style:none; padding:0; margin:0;">
          ${list.slice(0, 8).map(({ item }) => `
            <li style="border-top:1px solid #f3f4f6;">
              <a href="/blog/${item.id}/" style="display:block; padding:12px 14px; text-decoration:none;">
                <div style="font-weight:600; color:#111827;">
                  ${escapeHtml(item.title || "（無題）")}
                </div>
                ${item.description ? `<div style="margin-top:4px; color:#6b7280; font-size:12px;">${escapeHtml(item.description)}</div>` : ""}
              </a>
            </li>
          `).join("")}
        </ul>
      </div>
    `;
    resultEl.innerHTML = html;
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  input.addEventListener("input", () => {
    const q = input.value.trim();
    if (!q || !fuse) { render([]); return; }
    const hits = fuse.search(q);
    render(hits);
  });

  // 入力欄が空になったら候補を消す（×ボタン等にも追従）
  input.addEventListener("search", () => {
    if (!input.value.trim()) render([]);
  });

  load();
</script>
